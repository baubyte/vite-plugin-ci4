var t={hotFile:"hot",buildDirectory:"build",publicDirectory:"public",ssrOutputDirectory:"writable/ssr",alias:{"@components":"/resources/components","@contexts":"/resources/contexts","@layouts":"/resources/layouts","@styles":"/resources/styles","@utils":"/resources/utils","@hooks":"/resources/hooks",types:"/resources/types"},refreshPaths:["app/Views/*","modules/**/Views/*","app/Config/Routes.php","modules/**/Config/Routes.php"],plugin:"ci4",pluginName:"@baubyte/vite-plugin-ci4",frameworkName:"CodeIgniter",frameworkCompatibleVersion:"4.1.5",framework:"codeigniter4/framework",manifestPath:"manifest.json",ssrManifestPath:"manifest.json",assets:"app_assetURL",placeholder:"app_baseURL",placeholderRegExp:/{{app_baseURL}}/g,serverListener:"index.html",composerPath:"composer.lock"};var p=r=>{let{buildDirectory:e,composerPath:o,framework:s,pluginName:i,publicDirectory:l}=t,n;switch(r){case 8:n=`${i}: input too long for 'ssrOutputDirectory'.`;break;case 6:n=`${i}: ${s} not found in ${o}.`;break;case 5:n=`${i}: input too long for 'buildDirectory'.`;break;case 7:n=`${i}: input too long for 'publicDirectory'.`;break;case 0:n=`${i}: missing configuration for 'input'.`;break;case 1:n=`${i}: unable to write 'hot' file.`;break;case 3:n=`${i}: buildDirectory must be a subdirectory. E.g. '${e}'.`;break;case 4:n=`${i}: publicDirectory must be a subdirectory. E.g. '${l}'.`;break;default:n=`${i}: missing configuration.`;break}return n};import{access as W,constants as G,readFile as z,unlink as K,writeFile as Q}from"node:fs/promises";import{normalizePath as c}from"vite";var X=async r=>{try{return await W(r,G.F_OK),!0}catch{return!1}},f=async r=>{let e=c(r);if(!await X(e))throw new Error(e+" not found.");return await z(e,{encoding:"utf8"})},d=async r=>{try{return JSON.parse(await f(r))}catch(e){throw e instanceof SyntaxError?new SyntaxError("It is not a valid Json file.",{cause:e.message}):e}},C=async(r,e)=>{let o=c(r);try{return await Q(o,e),!0}catch{return!1}},D=async r=>{let e=c(r);try{return await K(e),!0}catch{return!1}};import{join as Y}from"path";var a=(...r)=>Y(...r);import{dirname as Z,join as rr}from"path";import{fileURLToPath as x}from"url";var w=r=>typeof r=="object",S=r=>r.family==="IPv6"||r.family===6,I=()=>{let r=new URL(".",import.meta.url);return x(r)},k=()=>{let r=x(import.meta.url),e=Z(r);return rr(e,"package.json")},y=r=>r.replace(/\/?$/,"/");var F=(r,e)=>{let o=typeof e.server.hmr=="object"?e.server.hmr.protocol:null,s=o?o==="wss"?"https":"http":null,i=e.server.https?"https":"http",l=s??i,n=typeof e.server.hmr=="object"?e.server.hmr.host:null,m=typeof e.server.host=="string"?e.server.host:null,u=S(r)?`[${r.address}]`:r.address,P=n??m??u,q=(typeof e.server.hmr=="object"?e.server.hmr.clientPort:null)??r.port;return e.server?.origin??`${l}://${P==="[::1]"?"localhost":P}:${q}`};import{loadEnv as er}from"vite";var U=({config:r,middlewares:e})=>{let{serverListener:o,placeholder:s,placeholderRegExp:i}=t,l=er(r.mode,r.envDir||process.cwd(),"")[s]??"undefined";return e.use(async(n,m,u)=>{n.url===`/${o}`&&(m.writeHead(200,{"Content-Type":"text/html"}),m.end((await f(a(I(),o))).replace(i,l))),u()})};import{loadEnv as tr}from"vite";import g from"picocolors";var h=r=>`  ${g.green("\u279C")}  ${g.white(r.name)}: ${g.cyan(r.version)}`;import{lt as or}from"semver";var $=async()=>{let e=(await d(t.composerPath)).packages?.find(({name:o})=>o===t.framework);if(typeof e?.version!="string")throw new Error(p(6));if(or(e.version,t.frameworkCompatibleVersion))throw new Error(`CompatibilityError: ${e.name}@${e.version} is not compatible with ${t.pluginName}. Use ${t.frameworkName}@${t.frameworkCompatibleVersion}`,{cause:"CompatibilityError"});return e},R=async()=>await d(k());var A=r=>{let{placeholder:e}=t,{mode:o,envDir:s,logger:i}=r.config,l={name:"App Url",version:tr(o,s||process.cwd(),"")[e]??"undefined"};setTimeout(()=>{i.info(""),Promise.all([$(),R()]).then(n=>{if(r.resolvedUrls)for(let m of n)i.info(h({name:m.name,version:`v${m.version.replace("v","")}`}))}).catch(n=>{i.error(n),r.close()}).finally(()=>i.info(`
`+h(l)))},100)};var j=()=>{process.on("exit",ir),process.on("SIGINT",v),process.on("SIGTERM",v),process.on("SIGHUP",v)},v=()=>process.exit(),ir=()=>{let{hotFile:r,publicDirectory:e}=t,o=a(e,r);D(o)};var E=r=>{let{publicDirectory:e,hotFile:o}=t,s=a(e,o);return r.httpServer?.once("listening",()=>{let i=r.httpServer?.address();w(i)&&C(s,F(i,r.config)).then(()=>A(r)).catch(()=>{r.config.logger.error(p(1)),r.close()})}),j(),()=>U(r)};import{loadEnv as sr}from"vite";var O=r=>Array.isArray(r.resolve?.alias)?[...r.resolve?.alias??[],...Object.keys(t.alias).map(e=>({find:e,replacement:t.alias[e]}))]:{...t.alias,...r.resolve?.alias};var T=(r,e,o,s)=>e.base??(r.command==="build"?y(s).concat(y(o.buildDirectory)):"");var V=(r,e,o)=>({input:r.build?.rollupOptions?.input??o?e.ssr:e.input});var b=(r,e,o)=>o?r.build?.ssrManifest??(e?t.ssrManifestPath:!1):r.build?.manifest??(e?!1:t.manifestPath);var L=r=>{let e=r.ssr?.noExternal,o=[t.pluginName];return e===!0?!0:typeof e>"u"?o:[...Array.isArray(e)?e:[e],...o]};var H=(r,e,o)=>r.build?.rollupOptions?.input??o?e.ssrOutputDirectory:a(e.publicDirectory,e.buildDirectory);var N=(r,e,o)=>{let s=!!r.build?.ssr,i=sr(e.mode,r.envDir||process.cwd(),""),l=i[t.assets]??i[t.placeholder]??"";return{publicDir:o.publicDirectory??!1,base:T(e,r,o,l),build:{manifest:b(r,s),ssrManifest:b(r,s,!0),outDir:H(r,o,s),rollupOptions:V(r,o,s),assetsInlineLimit:r.build?.assetsInlineLimit??0},resolve:{alias:O(r)},ssr:{noExternal:L(r)}}};var J=r=>{let e="",o;return{enforce:"post",name:t.plugin,config:(s,i)=>N(s,i,r),configResolved:s=>{o=s},transform:s=>{if(o.command==="serve"&&e&&(s=s.replace(/__ci4_vite_placeholder__/g,e),r.transformOnServe))return r.transformOnServe(s,e)},configureServer:s=>(s.httpServer?.once("listening",()=>{let i=s.httpServer?.address();if(i&&typeof i=="object"){let l=o.server.https?"https":"http",n=o.server.host||"localhost";e=`${l}://${n}:${i.port}`}}),E(s))}};import nr from"vite-plugin-full-reload";var M=({refresh:r})=>typeof r=="boolean"?[]:(typeof r=="string"&&(r=[{paths:[r]}]),Array.isArray(r)||(r=[r]),r.some(e=>typeof e=="string")&&(r=[{paths:r}]),r.flatMap(e=>{let o=nr(e.paths,e.config);return o.__ci4_plugin_config=e,o}));var B=r=>{if(typeof r>"u")throw new Error(p(2));if((typeof r=="string"||Array.isArray(r))&&(r={input:r,ssr:r}),typeof r.input>"u")throw new Error(p(0));if(typeof r.publicDirectory=="string"){if(r.publicDirectory.length>1e3)throw new Error(p(7));if(r.publicDirectory=r.publicDirectory.trim().replace(/^\/+/,""),r.publicDirectory==="")throw new Error(p(4))}if(typeof r.buildDirectory=="string"){if(r.buildDirectory.length>1e3)throw new Error(p(5));if(r.buildDirectory=r.buildDirectory.trim().replace(/^\/+/,"").replace(/\/+$/,""),r.buildDirectory==="")throw new Error(p(3))}if(typeof r.ssrOutputDirectory=="string"){if(r.ssrOutputDirectory.length>1e3)throw new Error(p(8));r.ssrOutputDirectory=r.ssrOutputDirectory.trim().replace(/^\/+/,"").replace(/\/+$/,"")}return r.refresh===!0&&(r.refresh=[{paths:t.refreshPaths}]),{input:r.input,ssr:r.ssr??r.input,refresh:r.refresh??!1,buildDirectory:r.buildDirectory??t.buildDirectory,publicDirectory:r.publicDirectory??t.publicDirectory,ssrOutputDirectory:r.ssrOutputDirectory??t.ssrOutputDirectory,transformOnServe:r.transformOnServe??(e=>e),hotFile:r.hotFile??a(r.publicDirectory??t.publicDirectory,t.hotFile)}};var pr=r=>{let e=B(r);return[J(e),...M(e)]},Te=pr;export{Te as default};
